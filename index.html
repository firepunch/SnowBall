<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Socket.io</title>

  <!--script src="http://code.jquery.com/jquery-1.10.1.min.js"></script-->
  <script src="/socket.io/socket.io.js"></script>

  <link rel="stylesheet" href="/public/css/style.css">
</head>

<body onload="modalFunction()">
  <div id="myModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>SNOW BALL</h2>
      </div>
      <div class="modal-body">
        <input type="text" placeholder="Nick" id="nickBox"/>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal" id="guest">Play as guest</button>
        <button type="button" class="btn btn-warning" data-dismiss="modal" id="login">Login and play</button>
      </div>
    </div>
  </div>

  <p><input type="button" value="massage to server" id="toServer" /></p>
  <canvas id="myCanvas" style="background:  #FAEBD7"></canvas>


  <script>
    // Socket connencting
    var socket = io.connect('http://localhost:3002', {port: 3002, transports: ["websocket"]});    
    function modalFunction() {
      var modal = document.getElementById('myModal');
      var nicBox = document.getElementById('nickBox');
      var guest = document.getElementById('guest');
      var toServer = document.getElementById('toServer');
      
      modal.style.display = 'block';
      // When the user press enter key, play as guest
      nickBox.addEventListener("keyup", function(event) {
        event.preventDefault();
        if (event.which == 13 || event.keyCode == 13){
            //https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Creating_and_triggering_events#Triggering_built-in_events
            // Dispatch/Trigger/Fire the event
            return;
        }
      });
      guest.addEventListener('mousedown', function() {
        var nickname = nickBox.value;
        socket.emit('nickname', nickname);
        modal.style.display = 'none';
      });
    }

    // message to server
    socket.on('message', function(message) {
      alert('server : ' + message);
    });

    toServer.addEventListener('mousedown', function() {
      socket.emit('message', 'HP decrease');
    });

    //game
    socket.on('init',function(data){
      //{ player : [{id:123,number:'1',x:0,y:0},{id:1,number:'2',x:0,y:0}], bullet: []}
      for(var i = 0 ; i < data.player.length; i++){
        new Player(data.player[i]);
      }
    });

    socket.on('update',function(data){
      //{ player : [{id:123,x:0,y:0},{id:1,x:0,y:0}], bullet: []}
      for(var i = 0 ; i < data.player.length; i++){
        var pack = data.player[i];
        var p = Player.list[pack.id];
        if(p){
          if(pack.x !== undefined)
            p.x = pack.x;
          if(pack.y !== undefined)
            p.y = pack.y;
        }
      }
    });

    socket.on('remove',function(data){
      //{player:[12323],bullet:[12323,123123]}
      for(var i = 0 ; i < data.player.length; i++){
        delete Player.list[data.player[i]];
      }
    });

/*
    document.onkeydown = function(event){
      if(event.keyCode === 68)	//d
        socket.emit('keyPress',{inputId:'right',state:true});
      else if(event.keyCode === 83)	//s
        socket.emit('keyPress',{inputId:'down',state:true});
      else if(event.keyCode === 65) //a
        socket.emit('keyPress',{inputId:'left',state:true});
      else if(event.keyCode === 87) // w
        socket.emit('keyPress',{inputId:'up',state:true});

    }
    document.onkeyup = function(event){
      if(event.keyCode === 68)	//d
        socket.emit('keyPress',{inputId:'right',state:false});
      else if(event.keyCode === 83)	//s
        socket.emit('keyPress',{inputId:'down',state:false});
      else if(event.keyCode === 65) //a
        socket.emit('keyPress',{inputId:'left',state:false});
      else if(event.keyCode === 87) // w
        socket.emit('keyPress',{inputId:'up',state:false});
    }

    document.onmousedown = function(event){
      socket.emit('keyPress',{inputId:'attack',state:true});
    }
    document.onmouseup = function(event){
      socket.emit('keyPress',{inputId:'attack',state:false});
    }
    document.onmousemove = function(event){
      var x = -250 + event.clientX - 8;
      var y = -250 + event.clientY - 8;
      var angle = Math.atan2(y,x) / Math.PI * 180;
      socket.emit('keyPress',{inputId:'mouseAngle',state:angle});
    }*/
  </script>

  <script type="text/javascript" src="/public/js/game.core.js"></script>
</body>
</html>